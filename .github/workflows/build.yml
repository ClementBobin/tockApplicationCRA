name: Build and Release Tock UI



on:

  push:

    branches:

      - main

      - master

  pull_request:

    branches:

      - main

      - master

  workflow_dispatch:




permissions:

  contents: write

  issues: write

  pull-requests: write



jobs:

  build-and-release:

    strategy:

      fail-fast: false

      matrix:

        include:

          - platform: 'ubuntu-22.04'

            args: ''

            artifact_name: 'linux'


            node_version: '20'  # Keep Node 20 for Tauri build

          - platform: 'windows-latest'

            args: ''

            artifact_name: 'windows'


            node_version: '20'  # Keep Node 20 for Tauri build



    runs-on: ${{ matrix.platform }}



    steps:

      - name: Checkout repository

        uses: actions/checkout@v4

        with:

          fetch-depth: 0




      - name: Setup Node.js for Tauri build

        uses: actions/setup-node@v4

        with:


          node-version: ${{ matrix.node_version }}

          cache: 'npm'

          cache-dependency-path: 'tock-ui/package-lock.json'



      - name: Install Rust stable

        uses: dtolnay/rust-toolchain@stable



      - name: Install Linux dependencies

        if: matrix.platform == 'ubuntu-22.04'

        run: |

          sudo apt-get update

          sudo apt-get install -y \

            libwebkit2gtk-4.1-dev \

            libappindicator3-dev \

            librsvg2-dev \

            patchelf \

            libssl-dev \

            libgtk-3-dev



      - name: Cache Rust dependencies

        uses: swatinem/rust-cache@v2

        with:

          workspaces: './tock-ui/src-tauri -> target'



      - name: Install frontend dependencies

        working-directory: ./tock-ui

        run: npm ci



      - name: Build Tauri application

        working-directory: ./tock-ui

        run: npm run tauri build -- ${{ matrix.args }}

        env:

          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}

          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}



      - name: Upload artifacts

        uses: actions/upload-artifact@v4

        with:

          name: ${{ matrix.artifact_name }}-artifacts

          path: |

            tock-ui/src-tauri/target/release/bundle/

          retention-days: 7



  semantic-release:

    needs: build-and-release

    runs-on: ubuntu-latest

    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')



    steps:

      - name: Checkout repository

        uses: actions/checkout@v4

        with:

          fetch-depth: 0




      # âš¡ USE NODE 22 FOR SEMANTIC-RELEASE


      - name: Setup Node.js 22 for semantic-release

        uses: actions/setup-node@v4

        with:


          node-version: '22'


          cache: 'npm'


          cache-dependency-path: 'tock-ui/package-lock.json'



      - name: Install semantic-release dependencies

        working-directory: ./tock-ui

        run: |


          # Clean install with Node 22


          npm ci









      - name: Download all build artifacts

        uses: actions/download-artifact@v4

        with:

          path: dist-artifacts



      - name: Prepare artifacts for release

        run: |


          mkdir -p release-artifacts



          find dist-artifacts -type f \( -name "*.deb" -o -name "*.AppImage" -o -name "*.msi" -o -name "*.exe" \) \

            -exec cp {} release-artifacts/ \;


          echo "Artifacts ready:"



          ls -la release-artifacts/



      - name: Semantic Release

        working-directory: ./tock-ui

        env:

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: npx semantic-release
